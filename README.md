# SVK
Простой клиент для работы с VK API написанный из учебного интереса и от скуки. Не рекомендую всерьез это использовать, может быть много недоработок.
# Что требуется из библиотек для работы?
- Requests
- Cherrypy (для callback-сервера)
> Также можете воспользоваться командой
```
pip/pip3 install -r requirements.txt
```
# Начало работы
> Если вам проще изучить код, то можете изучить скрипт example.py
- Инициализация Longpoll/Callback клиента
```python
from client import Longpoll, Callback

app = Longpoll(
  access_token='YOUR_TOKEN', # токен группы
  # также есть прочие параметры, о них речь ниже
)

callback_app = Callback(
  access_token='YOUR_TOKEN', # токен
  confirmation='CONFIRM_CODE', # ключ подтверждения
  secret='SECRET_KEY' # секретный ключ
)

# запуск Longpoll'а
app.poll(
  multithreading=True # настройка многопоточности
  threads_amount=5 # кол-во потоков
)

# запуск callback'а, если вы запускаете напрямую
callback_app.launch_server(
  ip='127.0.0.1',
  port=80
)
# получение сервера, если вы хотите запустить сервер иначе (например через UWSGI)
callback_server = callback_app.get_sever()
```
## Параметры клиента (и Longpoll, и Callback)
| Параметр | Описание |
|-----:|:----|
|access_token| Токен группы, строка, **единственный обязательный параметр** |
|api_timeout| Максимальное время ожидания ответа от API, число |
|api_version| Версия API, строка |
|handle_callback| Обрабатывать по дефолту сообщения типа message_event (из callback-кнопок), boolean |
|handle_payload| Обрабатывать по дефолту команды из payload'а (обычные кнопки, н-р), boolean |
|predict_commands| "Угадывать" ли команды, об этом пойдет речь дальше, boolean |
|message_error_handler | Функция или callable объект, которй будет вызван при получении ошибки во время обработки сообщения (*далее об этом есть раздел*) |
|other_error_handler | Фунция или callable объект, который будет вызван при получении ошибки во время обработки события (*далее об этом тоже есть раздел*) |
## Параметры только Longpoll клиента
| Параметр | Описание |
|-----:|:-----|
|wait| Время ожидания от Longpoll'а ВКонтакте|
## Параметры только Callback клиента
| Параметр | Описание |
|------:|:-----|
|secret| Секретный ключ вашего сервера, если его нет, то не трогайте параметр |
|confirmation| Ключ подтверждения, если хотите получить его через API, оставьте пустым |
# Как обработать соообщение?
> Обработка сообщения по регулярному выражению/командам
Для обработки определнных шаблонов сообщения используются обратчики функций, объявляемые через декоратор
```python
from client import Longpoll

app = Longpoll(...)

# обработка по команде
app.message_handler(commands=['hello'])
def command_handle(message):
  app.reply(message, 'Hi!') # функция ответа на сообщение

# обработка по регулярному выражению
app.message_handler(regex=[r'^regex ([0-9]{1,}) (.{1,})
def regex_handle(message, matches):
  app.reply(message, 'Сработало регулярное выражение')
```
> Важное примечание: регулярные выражения по дефолту регистронезависимы, а при ненахождении нужной команды применяется поиск по совпадениям при помощи формулы расстояния Дамерау-Левенштейна. "Угадывание" команды помогает в случае опечаток, но может и навредить. Полностью отключить его можно параметром predict_commands
> Важное примечание 2: если срабатывает один из обработчиков, другие обработчики не оповещаются. Об обработке всех сообщений речь пойдет далее.
## Разбираем механику работы
При получении события, бот обходит все обработчики и если фильтры обработчика удовлетворяют, то бот вызывает это функцию с параметром события (сообщения) и в случае с командой по регулярному выражению с массивом/строкой совпадения групп. *О структуре параметра сообщения/события речь пойдет дальше*
## Параметры обработчиков сообщений (через app.message_handler)
| Параметр | Описание |
|---------:|:--------|
|commands| Массив строк-слов, с которых сообщение должно начаться. **Если указано и регулярное выражение, команды имеют больший приоритет, две проверки за раз невозможны** |
|prefix| **Для команд**. Префикс, который добавится ко всем командам, строка. Необязателен. |
|predict| **Для команд**. Нужно ли конкретному обработчику "угадывать" команды. Необязателен. |
|regex| Регулярное выражение в виде строки. Регистронезависимо по дефолту. |
|message_type| Массив типов сообщений для обработки, список типов: text (простое текстовое сообщение), payload (сообщение из payload'а), callback (сообщение из callback-кнопок). При неуказании используются параметры из класса клиента. |
| &#95;filter | Функция или callable объект, которому передается объект сообщения. Должен вернуть True или False. Необязателен. |
## Обработка всех сообщений
Чтобы обработчик начал обрабатывать все сообщения, не указывайте regex или commands. В таком случае все обработчики всех сообщений будут вызваны.
# Как обрабатывать событие?
Для обработки события используйте декоратор **app.custom_handler**. Имеет единственный параметр - тип события с https://vk.com/dev/groups_events
```python
app.custom_handler('message_deny')
def message_deny_handler(event):
  print(event.user_id) # выводит айди пользователя, запретившего написание сообщений в ЛС
```
# Структура событий и сообщений
Различные обработчики передают функции либо объект события, либо объект сообщения. Помимо общих параметров, вы можете напрямую обращаться к аттрибутам событий.
```python
app.message_handler()
def print_from_id(message):
  print(message.from_id)

app.custom_handler('like_add')
def print_liker_id(event):
  print(event.liker_id)
```
## Общие параметры объекта события
